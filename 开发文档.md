# 碰个头 开发文档

## 1. 项目概述
- 项目名称：碰个头（OnTheWay）
- 形态：单页 Web 应用（`index.html`）
- 目标：输入多人出发地与口味偏好，推荐聚会地点，并展示地图点位与出行时长

## 2. 技术方案
- 前端：原生 `HTML + CSS + JavaScript`
- AI 推荐：`DeepSeek Chat Completions API`
- 地图能力：高德 Web 服务 API（静态图 + 地理编码 + 路径规划）
- 部署方式：静态文件部署（本地可直接起 HTTP 服务）

## 3. 当前功能（MVP+）
- 支持动态增删成员（至少 3 人）
- 每个成员可填写：
  - 出发地址
  - 口味偏好（单选）
- 支持调用 DeepSeek 生成最多 3 个候选聚会地点
- 支持选择“最终聚会地点”（A/B/C）
- 支持选择“出行方式”并计算成员到最终地点时长：
  - 驾车
  - 公交
  - 步行
  - 骑行
- 地图展示：
  - 成员点位（蓝色）
  - 候选地点点位（橙色），已选地点高亮（红色）
  - 成员地址面板
  - 候选地点面板
  - 路径时长面板
- 无 Key 时自动进入演示模式（Mock）

## 4. 关键文件
- `index.html`：页面结构、样式、业务逻辑（核心）
- `PRD.md`：MVP 产品需求
- `README.md`：项目说明（后续可继续同步更新）
- `开发文档.md`：本文件
- `开发日志.md`：版本开发记录

## 5. 核心逻辑说明

### 5.1 推荐生成
- 函数：`generateMeetingPoint()`
- 流程：
  1. 收集成员与时间输入
  2. 有 `DeepSeek API Key` 时调用 `callDeepSeekAPI()`
  3. 无 Key 时走 `getMockRecommendations()`
  4. 调用 `displayResult()` 渲染结果

### 5.2 地图渲染
- 函数：`initMap()` -> `renderStaticMap()` / `renderMockMap()`
- 逻辑：
  - 有高德 Key：真实地图渲染
  - 无高德 Key 或请求失败：自动降级到演示地图

### 5.3 时长计算
- 配置来源：
  - `finalVenueSelect`（最终地点）
  - `travelModeSelect`（出行方式）
- 函数：
  - `buildRouteDurations()`
  - `getRouteDurationMinutes()`
  - `getDrivingDurationMinutes()`
  - `getTransitDurationMinutes()`
  - `getWalkingDurationMinutes()`
  - `getCyclingDurationMinutes()`

## 6. API 清单

### 6.1 DeepSeek
- `POST https://api.deepseek.com/chat/completions`

### 6.2 高德 Web 服务
- 地理编码：`GET /v3/geocode/geo`
- 静态地图：`GET /v3/staticmap`
- 驾车：`GET /v3/direction/driving`
- 公交：`GET /v3/direction/transit/integrated`
- 步行：`GET /v3/direction/walking`
- 骑行：`GET /v4/direction/bicycling`

## 7. Key 配置与存储
- 页面输入项：
  - `deepseekKey`
  - `amapKey`
- 本地存储（`localStorage`）：
  - `ontheway_deepseek_key`
  - `ontheway_amap_key`

## 8. 本地运行
```powershell
cd D:\Project\map\OnTheWay
python -m http.server 5500
```
打开：`http://localhost:5500`

## 9. 常见问题

### 9.1 高德报错 `USERKEY_PLAT_NOMATCH`
- 原因：Key 的平台类型与当前调用方式不匹配
- 建议：
  1. 在高德控制台确认 Web 服务 Key 配置
  2. 检查白名单（域名/IP）是否包含当前环境
  3. 确认使用的是 Web 服务能力，而非 JS API Key

### 9.2 地图无法显示
- 检查 Key 是否为空、是否过期、是否超配额
- 网络异常时会自动降级为演示模式

## 10. 后续建议
- 将 `index.html` 拆分为模块（`js/` + `css/`）
- 增加“选择地点后画路线折线”能力
- 增加可观测日志（请求耗时、失败原因统计）
- 增加接口代理层，避免前端直连敏感 Key
